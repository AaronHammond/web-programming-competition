doctype html
html(style='height: 100%')
	head

		meta(name='viewport', content='initial-scale=1.0, user-scalable=no')
		script(type='text/javascript', src='/js/jquery-1.10.2.js')
		script(type='text/javascript', src='/js/bootstrap.js')
		link(type='stylesheet', href='/css/bootstrap.css')

		style(type='text/css').
			
			body {
				height: 100%;
				margin: 0;
				padding: 0
				text-align: center;
			}
			#map-canvas {
				height: 80%;
				width: 60%;
				margin-left: 20%;
			}
	body
		script(type='text/javascript', src='https://maps.googleapis.com/maps/api/js?key=AIzaSyAYb9WeDx9yd4CQd_e6lcb3NueQyqw-7Wo&sensor=false')
		script.

			var map;
			function createAddressFromYelpLocation(loc){
				return loc.address[0] + ", " + loc.city + ", " + loc.state_code;
			}
			
			// adds a marker to the map from google map data and a yelp datum
			function addMapPin(gmapData, datum){
				console.log(gmapData);
				var point = gmapData.results[0].geometry.location
				var markerPos = new google.maps.LatLng(point.lat, point.lng);
				marker = new google.maps.Marker({
					map:map,
					animation: google.maps.Animation.DROP,
					position: markerPos,
					title: datum.name
				});
			}

			// consumes the response from the yelp API and processes each business entry
			function processYelpData(data){
				for(var business in data.businesses){
					biz = data.businesses[business];
					processYelpDatum(biz);
				}
			}

			function processYelpDatum(datum){
				var display_address = createAddressFromYelpLocation(datum.location);
				// get the x/y coords
				$.ajax({
						url: "http://maps.googleapis.com/maps/api/geocode/json?address=" + display_address + "&sensor=true",
						cache: false
					}).done(function(gmapData){
							if(gmapData.results.length > 0){
								addMapPin(gmapData, datum);		
							}
							else{
								setTimeout(function(){processYelpDatum(datum);}, 1000);
							}
						});
			}
			function initialize() {
				navigator.geolocation.getCurrentPosition(function (position) {
						var mapOptions = {
							center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
							zoom: 17
						};
						map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

						$.ajax({
							url: "/data/restaurants?lat=" + position.coords.latitude + "&long=" + position.coords.longitude,
							cache: false
						}).done(processYelpData);




					});		
			}
			google.maps.event.addDomListener(window, 'load', initialize);






		div(id='map-canvas')
